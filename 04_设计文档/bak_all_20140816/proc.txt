drop procedure if exists update_interest_amount;
drop procedure if exists proc_update_interest_amount;

CREATE PROCEDURE proc_update_interest_amount ()
  top: BEGIN
  -- 本程序每月20日凌晨3:00自动启动，如果过期未执行，则在第一次系统启动时执行，始终计算截至最近上一周期的20日的利息。
  
  -- 默认结息日为每月的20日
  declare const_interest_day int default 20;  
  
  declare current_interest_day date;  -- 本次结息日
  declare _project_id char(36);
  declare _min_trice datetime;  
  declare _row_count int default 0;
  
  declare _id char(36);
  declare _amount decimal(20, 4) default 0.0;
  declare _interest_amount decimal(20, 4) default 0.0;
  declare _interest_rate decimal(20, 4) default 0.0;
  declare _trice datetime;  
  
  -- 定义游标的结束符
  declare eof bit default 0;
  
  -- 已经计算利息的，将记录的version字段，修改为300，如果利率为0，则忽略，不计利息。
	-- declare cur_arrears cursor for select id, project_id, amount, interest_amount, interest_rate, trice from t_arrears where ifnull(`version`, 0) != 300 and ifnull(interest_rate, 0) > 0;
  -- 按合同项目，分类汇总
  declare cur_project cursor for select project_id, min(trice) min_trice, count(id) row_count from t_arrears where project_id is not null and ifnull(`version`, 0) != 300 and ifnull(interest_rate, 0) > 0 group by project_id;
  declare continue handler for not found set eof = 1;  
  
  -- TODO：检测如果正在执行，则退出。
  if _amount * 10 > 0 then
    -- TODO 记录日志
    select '退出去了。';
    LEAVE top;
  end if;
  
  -- 开始执行，记录日志
  
  -- 计算本次结息日，如果现在在20日之前，则上月20日为结息日， 否则本月20日为结息日
  set current_interest_day = date_add(curdate(),interval - day(curdate()) + 20 day);
  if current_interest_day > now() then
    set current_interest_day = current_interest_day + interval -1 month;
  end if;
  -- select current_interest_day;
  
  open cur_project;
  
  top2: loop
    fetch cur_project into _project_id, _min_trice, _row_count;
    if eof = 1 then
      -- 遍历完成后，退出循环
      leave top2;
    end if;
    
    select sum(amount) from t_arrears where project_id=_project_id and rate>0 and trice<=
    
    
    
    select _id, _project_id, _amount, _interest_amount, _interest_rate, _trice;
    update t_arrears set description = '计算过了' where id=_id;
    
    update t_arrears set `version` = 300, description = concat(description, '，利息已结转') where project_id=_project_id and ifnull(`version`, 0) != 300 and ifnull(interest_rate, 0) > 0 and trice < current_interest_day;
  end loop top2;
  
  close cur_project;
END;

call proc_update_interest_amount()

select date_add(curdate(),interval - day(curdate())+ 20 day) + interval -1 month




select extract(year_month from now()) + 20



select curdate() - 2



select version, id, project_id, amount, interest_amount, interest_rate, trice from t_arrears

select id, project_id, amount, interest_amount, interest_rate, trice from t_arrears where ifnull(`version`, 0) != 300 and ifnull(interest_rate, 0) > 0


-- 按合同项目，分类汇总
select project_id, min(trice) min_trice, count(id) row_count from t_arrears where project_id is not null and ifnull(`version`, 0) != 300 and ifnull(interest_rate, 0) > 0 group by project_id


